import{a as f}from"./chunk-ZFEEVNKO.js";import{a as h}from"./chunk-ETT73BSF.js";import{ca as n,f as a,ia as c,kb as i,p as d,vc as u}from"./chunk-3P7EKYVL.js";var p=(()=>{class s{constructor(){this.databaseService=c(h),this._record=i(null),this.record=this._record,this.load()}load(){return a(this,null,function*(){let t=yield this.databaseService.db.usageRecords.toArray();this._record.set(t.length?t[0]:null)})}createIfNotExists(t){return a(this,null,function*(){(yield this.databaseService.db.usageRecords.count())===0?(yield this.databaseService.db.usageRecords.add(t),yield this.load()):console.warn("Ya existe un registro de uso. No se cre\xF3 uno nuevo.")})}update(t){return a(this,null,function*(){t.usageDate||(t.usageDate=new Date().toISOString());let e=this._record();if(!t.id){this.clear(),yield this.databaseService.db.usageRecords.add(t),yield this.load();return}yield this.databaseService.db.usageRecords.put(t),yield this.load()})}update1(t){return a(this,null,function*(){if(t.usageDate||(t.usageDate=new Date().toISOString()),!t.id){let e=this._record();if(e)t.id=e.id;else{let o=yield this.databaseService.db.usageRecords.toArray();if(o.length===0){yield this.databaseService.db.usageRecords.add(t),yield this.load();return}else t.id=o[0].id}}yield this.databaseService.db.usageRecords.put(t),yield this.load()})}clear(){return a(this,null,function*(){yield this.databaseService.db.usageRecords.clear(),this._record.set(null)})}static{this.\u0275fac=function(e){return new(e||s)}}static{this.\u0275prov=n({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})();var D=(()=>{class s{constructor(){this.usageRecordStoreService=c(p),this.db=c(f),this._products=i([]),this.products=u(()=>this._products()),this.loading=i(!1),this.error=i(null),this.filter=i(""),this.filteredProducts=u(()=>{let t=this.filter().toLowerCase();return this.products().filter(e=>e.name.toLowerCase().includes(t))}),this.loadAll()}loadAll(){return a(this,null,function*(){this.loading.set(!0),this.error.set(null);try{let t=yield this.db.getAllProducts();this._products.set(t)}catch(t){this.error.set("Error al cargar los productos"),console.error(t)}finally{this.loading.set(!1)}})}save(t){return a(this,null,function*(){d(this.db.addProduct(t)).subscribe({next:e=>{let o=e;d(this.loadAll()).subscribe({next:l=>{let r=this.findById(e);r!=null&&r!=null&&(r.package.productId=`${r.id}`,d(this.db.updateProduct(r)).subscribe({next:g=>{this.loadAll()}}))}})},error:e=>console.error("Error:",e)})})}update(t){return a(this,null,function*(){yield this.db.updateProduct(t),yield this.loadAll()})}delete(t){return a(this,null,function*(){yield this.db.deleteProduct(t),yield this.loadAll()})}findById(t){return this._products().find(e=>e.id===t)}setFilter(t){this.filter.set(t)}getPackageSummary(){let t=this.products(),e=0,o=0,l=0;for(let r of t)switch(r.package.status){case"In Use":e++;break;case"In Stock":o++;break;case"Empty":l++;break}return{inUse:e,inStock:o,empty:l}}applyUsage(t){return a(this,null,function*(){let e=this.findById(Number(t.productId));if(!e){this.error.set("Producto no encontrado para aplicar uso");return}e.package.currentQuantity-=t.quantityUsed,e.package.currentQuantity<0&&(e.package.currentQuantity=0),e.package.currentQuantity===0?e.package.status="Empty":e.package.status="In Use",yield this.db.updateProduct(e),yield this.loadAll(),t.productName=e.name,yield this.usageRecordStoreService.update(t)})}static{this.\u0275fac=function(e){return new(e||s)}}static{this.\u0275prov=n({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})();export{D as a};
