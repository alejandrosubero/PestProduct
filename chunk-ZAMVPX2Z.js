import{a as O}from"./chunk-K3BNIXJ3.js";import{a as M,c as D}from"./chunk-AXY7KQ3O.js";import"./chunk-SKLZSKAT.js";import{a as P}from"./chunk-53KECMHQ.js";import"./chunk-O6ZGCYQU.js";import"./chunk-L2CEHP2K.js";import{e as y}from"./chunk-N5FOZFUG.js";import{j as C,m as B}from"./chunk-P4PHYZLP.js";import"./chunk-KXJZ4KRG.js";import"./chunk-CARY4E7O.js";import"./chunk-GCRZXU3H.js";import"./chunk-4NVBDXTK.js";import{t as _}from"./chunk-MTHBGCRI.js";import{Bb as c,Cb as s,Hb as h,Kb as d,Qb as g,Rb as S,Sb as w,Ub as p,_a as b,bc as v,ca as m,f as a,ia as f,na as k,va as l,wa as u}from"./chunk-7EUIRZQQ.js";var x=(()=>{class n{constructor(){this.databaseService=f(P)}exportAll(){return a(this,null,function*(){return{products:yield this.databaseService.db.products.toArray(),packages:yield this.databaseService.db.packages.toArray(),usageRecords:yield this.databaseService.db.usageRecords.toArray(),formulations:yield this.databaseService.db.formulations.toArray(),legacyProducts:yield this.databaseService.db.legacyProducts.toArray()}})}getBackupBlob(){return a(this,null,function*(){let e=yield this.exportAll(),t=JSON.stringify(e,null,2);return new Blob([t],{type:"application/json"})})}importAll(e){return a(this,null,function*(){if(e.products)for(let t of e.products)delete t.id,yield this.databaseService.db.products.add(t);if(e.packages)for(let t of e.packages)delete t.id,yield this.databaseService.db.packages.add(t);if(e.usageRecords)for(let t of e.usageRecords)delete t.id,yield this.databaseService.db.usageRecords.add(t);if(e.formulations)for(let t of e.formulations)delete t.id,yield this.databaseService.db.formulations.add(t);if(e.legacyProducts)for(let t of e.legacyProducts)delete t.id,yield this.databaseService.db.legacyProducts.add(t)})}clearAll(){return a(this,null,function*(){yield this.databaseService.resetDatabase(),window.location.reload()})}static{this.\u0275fac=function(t){return new(t||n)}}static{this.\u0275prov=m({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();var F=["fileInput"],W=(()=>{class n{constructor(e,t){this.dialog=e,this._snackBar=t,this.isFabOpen=!1,this.durationInSeconds=3,this.horizontalPosition="center",this.verticalPosition="bottom",this.backupService=f(x)}export(){return a(this,null,function*(){try{let e=yield this.backupService.getBackupBlob(),t=new File([e],`backup-${new Date().toISOString()}.json`,{type:"application/json"});if(navigator.share&&navigator.canShare?.({files:[t]}))try{yield navigator.share({title:"Backup",text:"PestControlDB Backup",files:[t]}),console.log("\u2705 Backup shared");return}catch(r){console.warn("\u26A0\uFE0F Share cancelled or failed, falling back to download:",r)}let i=URL.createObjectURL(e),o=document.createElement("a");o.href=i,o.download=`backup-${new Date().toISOString()}.json`,o.click(),URL.revokeObjectURL(i),console.log("\u2B07\uFE0F Backup downloaded"),this.openSnackBar("\u2B07\uFE0F Backup downloaded")}catch(e){this.durationInSeconds=5,console.error("\u274C Error exporting backup",e),this.openSnackBar("\u274C Error exporting backup")}})}openFilePicker(){this.fileInput.nativeElement.click()}onFileSelected(e){return a(this,null,function*(){let t=e.target;if(t.files&&t.files.length>0){let i=t.files[0];try{let o=yield i.text(),r=JSON.parse(o);yield this.backupService.importAll(r),this.openSnackBar("\u2705 Backup imported successfully")}catch(o){this.durationInSeconds=5,console.error("\u274C Error importing backup",o),this.openSnackBar("\u274C Error importing backup")}finally{t.value="",this.durationInSeconds=3}}})}clear(){return a(this,null,function*(){yield this.backupService.clearAll(),this.showSnackBar("\u{1F5D1}\uFE0F All databases cleared")})}confirmDelete(){this.isFabOpen=!1,this.dialog.open(D,{data:{message:"Are you sure you want to delete this formulation?"}}).afterClosed().subscribe(t=>{t&&this.clear()})}openSnackBar(e){this._snackBar.open(e,"Ok",{duration:this.durationInSeconds*1e3,horizontalPosition:this.horizontalPosition,verticalPosition:this.verticalPosition})}showSnackBar(e){this.durationInSeconds=6,this._snackBar.open(e,"OK",{duration:this.durationInSeconds*1e3,horizontalPosition:this.horizontalPosition,verticalPosition:this.verticalPosition}).onAction().subscribe(()=>{window.location.reload()})}static{this.\u0275fac=function(t){return new(t||n)(b(M),b(O))}}static{this.\u0275cmp=k({type:n,selectors:[["app-backup"]],viewQuery:function(t,i){if(t&1&&g(F,5),t&2){let o;S(o=w())&&(i.fileInput=o.first)}},standalone:!0,features:[v],decls:11,vars:0,consts:[["fileInput",""],[1,"backup-container"],[1,"ios-button","export",3,"click"],[1,"ios-button","import",3,"click"],["type","file","accept",".json",2,"display","none",3,"change"],[1,"ios-button","clear",3,"click"]],template:function(t,i){if(t&1){let o=h();c(0,"div",1)(1,"h2"),p(2,"\u{1F4E6} Data Backup"),s(),c(3,"button",2),d("click",function(){return l(o),u(i.export())}),p(4," \u{1F4E4} Export / Share Backup "),s(),c(5,"button",3),d("click",function(){return l(o),u(i.openFilePicker())}),p(6," \u{1F4E5} Import Backup "),s(),c(7,"input",4,0),d("change",function(I){return l(o),u(i.onFileSelected(I))}),s(),c(9,"button",5),d("click",function(){return l(o),u(i.confirmDelete())}),p(10," \u{1F5D1}\uFE0F Clear Database "),s()()}},dependencies:[C,_,B,y],styles:[".backup-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;padding:2rem}.backup-container[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{font-size:1.4rem;margin-bottom:1.5rem;color:#333}.backup-container[_ngcontent-%COMP%]   .ios-button[_ngcontent-%COMP%]{width:90%;max-width:320px;padding:14px 18px;margin:10px 0;border-radius:12px;border:none;font-size:1.1rem;font-weight:500;text-align:center;cursor:pointer;transition:background .3s}.backup-container[_ngcontent-%COMP%]   .ios-button.export[_ngcontent-%COMP%]{background:#007aff;color:#fff}.backup-container[_ngcontent-%COMP%]   .ios-button.export[_ngcontent-%COMP%]:hover{background:#005ecb}.backup-container[_ngcontent-%COMP%]   .ios-button.import[_ngcontent-%COMP%]{background:#34c759;color:#fff}.backup-container[_ngcontent-%COMP%]   .ios-button.import[_ngcontent-%COMP%]:hover{background:#2fa94c}.backup-container[_ngcontent-%COMP%]   .ios-button.clear[_ngcontent-%COMP%]{background:#ff3b30;color:#fff}.backup-container[_ngcontent-%COMP%]   .ios-button.clear[_ngcontent-%COMP%]:hover{background:#d92d23}"]})}}return n})();export{W as BackupComponent};
